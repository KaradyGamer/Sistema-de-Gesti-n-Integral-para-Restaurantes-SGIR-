{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Mesas - Sistema de Caja</title>
    <link rel="stylesheet" href="{% static 'css/cajero/mapa_mesas.css' %}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🗺️ Mapa de Mesas en Tiempo Real</h1>
            <div class="user-info">
                <span>Cajero: <strong>{{ request.user.get_full_name }}</strong></span>
                <a href="/caja/" class="btn btn-secondary">← Volver</a>
                <a href="/usuarios/logout/" class="btn btn-danger">Cerrar Sesión</a>
            </div>
        </div>

        <div class="refresh-info">
            ℹ️ Esta página se actualiza automáticamente cada 10 segundos
        </div>

        <!-- Leyenda -->
        <div class="legend">
            <h3>📌 Leyenda de Estados</h3>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-color" style="background: #d4edda; border-color: #28a745;"></div>
                    <span><strong>Libre:</strong> Mesa disponible</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f8d7da; border-color: #dc3545;"></div>
                    <span><strong>Ocupada:</strong> Mesa con pedido activo</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fff3cd; border-color: #ffc107;"></div>
                    <span><strong>Reservada:</strong> Mesa reservada</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #d1ecf1; border-color: #17a2b8;"></div>
                    <span><strong>Pagando:</strong> En proceso de pago</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e2e3e5; border-color: #6c757d;"></div>
                    <span><strong>No Disponible:</strong> Mesa desactivada</span>
                </div>
            </div>
        </div>

        <!-- Estadísticas -->
        <div class="map-container">
            <div class="stats">
                <div class="stat-box" style="border-color: #28a745;">
                    <div class="number" style="color: #28a745;">{{ stats.libres }}</div>
                    <div class="label">Mesas Libres</div>
                </div>
                <div class="stat-box" style="border-color: #dc3545;">
                    <div class="number" style="color: #dc3545;">{{ stats.ocupadas }}</div>
                    <div class="label">Mesas Ocupadas</div>
                </div>
                <div class="stat-box" style="border-color: #ffc107;">
                    <div class="number" style="color: #ffc107;">{{ stats.reservadas }}</div>
                    <div class="label">Mesas Reservadas</div>
                </div>
                <div class="stat-box" style="border-color: #17a2b8;">
                    <div class="number" style="color: #17a2b8;">{{ stats.pagando }}</div>
                    <div class="label">En Proceso de Pago</div>
                </div>
            </div>

            <!-- Mapa de Mesas -->
            {% if mesas %}
            <div class="mesas-grid">
                {% for mesa in mesas %}
                <div class="mesa-card {% if not mesa.disponible %}no-disponible{% else %}{{ mesa.estado }}{% endif %}"
                     onclick="{% if mesa.disponible and mesa.estado != 'libre' %}verDetalleMesa({{ mesa.id }}){% endif %}">
                    <div class="mesa-numero">{{ mesa.numero }}</div>
                    <div class="mesa-estado">
                        {% if not mesa.disponible %}
                        🚫 No Disponible
                        {% elif mesa.estado == 'libre' %}
                        ✓ Libre
                        {% elif mesa.estado == 'ocupada' %}
                        👥 Ocupada
                        {% elif mesa.estado == 'reservada' %}
                        📅 Reservada
                        {% elif mesa.estado == 'pagando' %}
                        💰 Pagando
                        {% endif %}
                    </div>
                    <div class="mesa-info">
                        👤 Capacidad: {{ mesa.capacidad }} personas
                    </div>

                    {% if mesa.pedido_activo %}
                    <div class="mesa-pedido">
                        <strong>Pedido #{{ mesa.pedido_activo.id }}</strong>
                        <div class="mesa-info">
                            👨‍🍳 {{ mesa.pedido_activo.mesero.get_full_name }}
                        </div>
                        <div class="mesa-info">
                            💵 Bs/ {{ mesa.pedido_activo.total }}
                        </div>
                        <div class="mesa-tiempo">
                            ⏱️ {{ mesa.pedido_activo.tiempo_transcurrido }}
                        </div>
                    </div>

                    {% if mesa.estado == 'ocupada' or mesa.estado == 'pagando' %}
                    <div class="mesa-actions">
                        <a href="/caja/pedido/{{ mesa.pedido_activo.id }}/"
                           class="btn btn-primary"
                           onclick="event.stopPropagation()">
                            Ver
                        </a>
                        {% if mesa.pedido_activo.estado_pago == 'pendiente' %}
                        <a href="/caja/pedido/{{ mesa.pedido_activo.id }}/pagar/"
                           class="btn btn-success"
                           onclick="event.stopPropagation()">
                            Cobrar
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="no-mesas">
                📋 No hay mesas registradas en el sistema
            </div>
            {% endif %}
        </div>
    </div>

    <script src="{% static 'js/cajero/mapa_mesas.js' %}"></script>
</body>
</html>
