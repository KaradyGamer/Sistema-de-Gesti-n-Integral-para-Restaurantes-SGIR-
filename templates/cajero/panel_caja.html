{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - Sistema de Restaurante</title>
    <link rel="stylesheet" href="{% static 'css/cajero/panel_caja.css' %}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div>
                <h1>💰 {{ title }}</h1>
                <p style="color: #999;">Gestión de Pagos y Caja</p>
            </div>
            <div class="user-info">
                <p><strong>{{ nombre_usuario }}</strong></p>
                <p>Rol: {{ user_role|upper }}</p>
                <a href="/usuarios/logout/" class="logout-btn">Cerrar Sesión</a>
            </div>
        </header>

        <!-- Estado del Turno -->
        {% if turno_abierto %}
        <div class="turno-info">
            <strong>✅ Turno Abierto</strong> -
            {{ turno_abierto.get_turno_display }} |
            Apertura: {{ turno_abierto.hora_apertura|date:"H:i" }} |
            Efectivo inicial: Bs/ {{ turno_abierto.efectivo_inicial }}
        </div>
        {% else %}
        <div class="turno-info cerrado">
            <strong>⚠️ No hay turno abierto</strong> -
            <a href="{% url 'caja:abrir_caja' %}" class="btn" style="margin-left: 10px;">Abrir Turno</a>
        </div>
        {% endif %}

        <!-- Estadísticas del Día -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>💵 Ventas del Día</h3>
                <div class="value">Bs/ {{ estadisticas.totales.total|floatformat:2 }}</div>
            </div>
            <div class="stat-card">
                <h3>📊 Pedidos Totales</h3>
                <div class="value">{{ estadisticas.total_pedidos }}</div>
            </div>
            <div class="stat-card">
                <h3>✅ Pedidos Pagados</h3>
                <div class="value">{{ estadisticas.pedidos_pagados }}</div>
            </div>
            <div class="stat-card">
                <h3>⏳ Pendientes</h3>
                <div class="value">{{ estadisticas.pedidos_pendientes }}</div>
            </div>
        </div>

        <!-- Contenido Principal -->
        <div class="main-content">
            <!-- Pedidos Pendientes de Pago -->
            <div class="section">
                <h2>📋 Pedidos Pendientes de Pago</h2>

                {% if pedidos_pendientes %}
                    {% for pedido in pedidos_pendientes %}
                    <div class="pedido-card">
                        <div class="pedido-header">
                            <h3>Pedido #{{ pedido.id }}</h3>
                            <div>
                                <span class="badge" style="background:
                                    {% if pedido.estado == 'pendiente' %}#ffc107
                                    {% elif pedido.estado == 'en preparacion' %}#17a2b8
                                    {% elif pedido.estado == 'listo' %}#28a745
                                    {% elif pedido.estado == 'entregado' %}#6c757d
                                    {% endif %}; color: white; padding: 5px 10px; border-radius: 15px; margin-right: 10px;">
                                    {{ pedido.get_estado_display }}
                                </span>
                                <span class="mesa">Mesa {{ pedido.mesa.numero }}</span>
                            </div>
                        </div>
                        <div class="pedido-body">
                            <p><strong>Hora:</strong> {{ pedido.fecha|date:"H:i" }}</p>
                            <p><strong>Productos:</strong></p>
                            <ul class="productos-list">
                                {% for detalle in pedido.detalles.all %}
                                <li>{{ detalle.cantidad }}x {{ detalle.producto.nombre }} - Bs/ {{ detalle.subtotal|floatformat:2 }}</li>
                                {% endfor %}
                            </ul>
                            {% if pedido.observaciones %}
                            <p><strong>Observaciones:</strong> {{ pedido.observaciones }}</p>
                            {% endif %}
                        </div>
                        <div class="pedido-total">
                            Total: Bs/ {% if pedido.total_final > 0 %}{{ pedido.total_final|floatformat:2 }}{% else %}{{ pedido.total|floatformat:2 }}{% endif %}
                        </div>
                        <div class="actions">
                            <a href="{% url 'caja:detalle_pedido' pedido.id %}" class="btn">👁️ Ver Detalle</a>
                            <a href="{% url 'caja:modificar_pedido' pedido.id %}" class="btn" style="background: #ff9800;">✏️ Modificar</a>
                            {% if pedido.estado == 'entregado' %}
                            <a href="{% url 'caja:procesar_pago' pedido.id %}" class="btn btn-success">💰 Cobrar</a>
                            {% else %}
                            <button class="btn" style="background: #6c757d; cursor: not-allowed;" disabled title="El pedido debe estar 'Entregado' para cobrar">💰 Cobrar (Pendiente)</button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="empty-state">
                    <i>✅</i>
                    <h3>No hay pedidos pendientes</h3>
                    <p>Todos los pedidos han sido pagados</p>
                </div>
                {% endif %}
            </div>

            <!-- Panel Lateral -->
            <div>
                <!-- Alertas de Stock -->
                <div class="section">
                    <h2>⚠️ Alertas de Stock</h2>
                    {% if alertas_stock %}
                        {% for alerta in alertas_stock %}
                        <div class="alerta-stock {% if alerta.tipo_alerta == 'agotado' %}agotado{% endif %}">
                            <strong>{{ alerta.producto.nombre }}</strong><br>
                            <small>
                                {{ alerta.get_tipo_alerta_display }} -
                                Stock: {{ alerta.stock_actual }}
                            </small>
                        </div>
                        {% endfor %}
                        <a href="{% url 'caja:alertas_stock' %}" class="btn" style="width: 100%; text-align: center;">Ver Todas</a>
                    {% else %}
                    <div class="empty-state">
                        <p>✅ Sin alertas activas</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Acciones Rápidas -->
                <div class="section" style="margin-top: 20px;">
                    <h2>🚀 Acciones Rápidas</h2>
                    <a href="{% url 'caja:gestionar_jornada' %}" class="btn" style="width: 100%; text-align: center; margin-bottom: 10px; background: #ff9800;">📅 Gestión de Jornada</a>
                    <a href="{% url 'caja:personal_panel' %}" class="btn" style="width: 100%; text-align: center; margin-bottom: 10px; background: #28a745;">👥 Gestión de Personal</a>
                    <a href="{% url 'caja:mapa_mesas' %}" class="btn" style="width: 100%; text-align: center; margin-bottom: 10px;">🗺️ Mapa de Mesas</a>
                    <a href="{% url 'caja:historial' %}" class="btn" style="width: 100%; text-align: center; margin-bottom: 10px;">📜 Historial</a>
                    {% if turno_abierto %}
                    <a href="{% url 'caja:cierre_caja' %}" class="btn" style="width: 100%; text-align: center; background: #dc3545;">🔒 Cerrar Caja</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/cajero/panel_caja.js' %}"></script>
</body>
</html>