{% extends 'html/adminux/base_form.html' %}

{% block title %}{% if producto %}Editar Producto{% else %}Nuevo Producto{% endif %}{% endblock %}
{% block page_title %}{% if producto %}Editar Producto{% else %}Crear Nuevo Producto{% endif %}{% endblock %}
{% block page_description %}{% if producto %}Modifique los datos del producto{% else %}Complete el formulario para agregar un nuevo producto al menú{% endif %}{% endblock %}

{% block breadcrumb %}
<span>Productos</span>
<span>/</span>
<span>{% if producto %}Editar{% else %}Nuevo{% endif %}</span>
{% endblock %}

{% block back_url %}{% url 'adminux:productos' %}{% endblock %}
{% block cancel_url %}{% url 'adminux:productos' %}{% endblock %}

{% block form_attrs %}enctype="multipart/form-data"{% endblock %}

{% block form_content %}
<div class="form-grid">
    <div class="form-group col-span-2">
        <label for="nombre" class="required">Nombre del Producto</label>
        <input type="text" id="nombre" name="nombre" class="form-control"
               value="{{ producto.nombre|default:'' }}" required>
    </div>

    <div class="form-group col-span-2">
        <label for="descripcion">Descripción</label>
        <textarea id="descripcion" name="descripcion" class="form-control" rows="3">{{ producto.descripcion|default:'' }}</textarea>
        <small class="form-text">Describe brevemente el producto</small>
    </div>

    <div class="form-group">
        <label for="categoria" class="required">Categoría</label>
        <select id="categoria" name="categoria" class="form-select" required>
            <option value="">Seleccione una categoría</option>
            {% for categoria in categorias %}
            <option value="{{ categoria.id }}" {% if producto.categoria_id == categoria.id %}selected{% endif %}>
                {{ categoria.nombre }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="precio" class="required">Precio (S/)</label>
        <input type="number" id="precio" name="precio" class="form-control"
               value="{{ producto.precio|default:'0.00' }}" step="0.01" min="0" required>
    </div>

    <div class="form-group">
        <label for="stock" class="required">Stock</label>
        <input type="number" id="stock" name="stock" class="form-control"
               value="{{ producto.stock|default:'0' }}" min="0" required>
        <small class="form-text">Cantidad disponible en inventario</small>
    </div>

    <div class="form-group">
        <label for="disponible">Disponibilidad</label>
        <div class="form-check">
            <input type="checkbox" id="disponible" name="disponible" class="form-check-input"
                   {% if not producto or producto.disponible %}checked{% endif %}>
            <label for="disponible" class="form-check-label">Producto disponible para venta</label>
        </div>
    </div>

    <div class="form-group col-span-2">
        <label for="imagen">Imagen del Producto</label>
        <input type="file" id="imagen" name="imagen" class="form-control" accept="image/*">
        {% if producto.imagen %}
        <div class="mt-2">
            <p class="text-muted">Imagen actual:</p>
            <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" style="max-width: 200px; border-radius: 8px;">
        </div>
        {% endif %}
        <small class="form-text">Formatos aceptados: JPG, PNG, WEBP (máx. 5MB)</small>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const imagenInput = document.getElementById('imagen');
const stockInput = document.getElementById('stock');
const disponibleCheck = document.getElementById('disponible');

// Preview de imagen
imagenInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        if (file.size > 5 * 1024 * 1024) {
            window.adminUX.mostrarNotificacion('La imagen no debe superar 5MB', 'error');
            e.target.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const preview = document.createElement('img');
            preview.src = e.target.result;
            preview.style.maxWidth = '200px';
            preview.style.marginTop = '10px';
            preview.style.borderRadius = '8px';

            const existingPreview = imagenInput.parentElement.querySelector('img:not([src*="media"])');
            if (existingPreview) {
                existingPreview.remove();
            }

            imagenInput.parentElement.appendChild(preview);
        };
        reader.readAsDataURL(file);
    }
});

// Auto-deshabilitar si stock es 0
stockInput.addEventListener('input', (e) => {
    if (parseInt(e.target.value) === 0) {
        disponibleCheck.checked = false;
    }
});
</script>
{% endblock %}
